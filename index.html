<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BE/Javaスキンローダー</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/skinview3d@1.15.0/build/skinview3d.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: linear-gradient(to right, #fceabb, #f8b500);
      color: #333;
    }
    h1 {
      margin-bottom: 1rem;
      color: #000000;
    }
    select, input, button {
      margin: 0.5rem 0.25rem;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    select {
      background-color: #ffecb3;
    }
    input {
      background-color: #fff9c4;
    }
    button {
      background-color: #81d4fa;
      color: #01579b;
      cursor: pointer;
    }
    button:hover {
      background-color: #4fc3f7;
    }
    .skin-entry {
      background: linear-gradient(to bottom, #ffffff, #f0f0f0);
      border: 2px solid #ce93d8;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    canvas {
      width: 200px;
      height: 300px;
      margin-bottom: 1rem;
      border: 2px solid #ba68c8;
      border-radius: 8px;
    }
    label, input[type="text"], button {
      margin: 0.25rem 0;
    }
  </style>
</head>
<body>
  <h1>BE/Javaスキンローダー</h1>

  <select id="mode">
    <option value="be">BE</option>
    <option value="java">Java</option>
  </select>
  <input id="mcid" placeholder="プレイヤー名を入力..." />
  <button onclick="fetchSkin()">取得</button>

  <hr />
  <div id="skins"></div>

  <script>
    async function fetchSkin() {
      const mode = document.getElementById('mode').value;
      const mcid = document.getElementById('mcid').value.trim();
      if (!mcid) return alert('プレイヤー名を入力してください');

      let textureUrl = "";
      let fileName = mcid + ".png";

      try {
        if (mode === "be") {
          // BE版XUID取得
          const xuidRes = await fetch(`https://api.geysermc.org/v2/xbox/xuid/${encodeURIComponent(mcid)}`);
          if (!xuidRes.ok) throw new Error("XUID取得失敗");
          const xuid = await xuidRes.text();
          if (!xuid) throw new Error("XUIDが空です");

          // スキン情報取得
          const skinRes = await fetch(`https://api.geysermc.org/v2/skin/${xuid}`);
          if (!skinRes.ok) throw new Error("スキン情報取得失敗");
          const skinJson = await skinRes.json();
          if (!skinJson.texture_id) throw new Error("texture_idがありません");

          textureUrl = `https://textures.minecraft.net/texture/${skinJson.texture_id}`;
        } else {
          // Java版スキン情報をMineskin APIから取得
          const res = await fetch(`https://api.mineskin.org/get/user/${encodeURIComponent(mcid)}`);
          if (!res.ok) throw new Error("Javaスキン情報取得失敗");
          const json = await res.json();
          if (!json.data || !json.data.texture || !json.data.texture.value) throw new Error("スキンURLがありません");
          textureUrl = json.data.texture.value;
        }

        const container = document.createElement('div');
        container.className = 'skin-entry';

        const canvas = document.createElement('canvas');
        container.appendChild(canvas);

        const viewer = new skinview3d.SkinViewer({ canvas, width: 200, height: 300 });
        viewer.loadSkin(textureUrl);

        viewer.player.skin.image.addEventListener('error', () => {
          alert('スキン画像の読み込みに失敗しました。URLやCORSを確認してください。');
        });

        const label = document.createElement('label');
        label.textContent = "画像ファイル名: ";
        const input = document.createElement('input');
        input.value = fileName;
        input.type = 'text';
        container.appendChild(label);
        container.appendChild(input);

        const dlBtn = document.createElement('button');
        dlBtn.textContent = "スキン単体Download";
        dlBtn.onclick = () => downloadSkin(textureUrl, input.value);
        container.appendChild(dlBtn);

        document.getElementById('skins').appendChild(container);

      } catch (e) {
        alert("取得に失敗しました。もう一度お試しください: " + e.message);
      }
    }

    function downloadSkin(url, filename) {
      fetch(url)
        .then(res => res.blob())
        .then(blob => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename.endsWith('.png') ? filename : filename + '.png';
          a.click();
          URL.revokeObjectURL(a.href);
        });
    }
  </script>
</body>
</html>
