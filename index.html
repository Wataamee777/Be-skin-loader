<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BE/Javaスキンローダー</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/skinview3d@1.15.0/build/skinview3d.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f8f9fa;
      color: #333;
    }
    h1 {
      margin-bottom: 1rem;
    }
    select, input, button {
      margin: 0.5rem 0.25rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
    .skin-entry {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    canvas {
      width: 200px;
      height: 300px;
      margin-bottom: 1rem;
    }
    label, input[type="text"], input[type="checkbox"], button {
      margin: 0.25rem 0;
    }
  </style>
</head>
<body>
<h1>BE/Javaスキンローダー</h1>

<select id="mode">
  <option value="be">BE</option>
  <option value="java">Java</option>
</select>
<input id="mcid" placeholder="プレイヤー名を入力..." />
<button onclick="fetchSkin()">取得</button>

<hr>
<div id="skins"></div>

<script>
const skins = [];

async function fetchSkin() {
  const mode = document.getElementById('mode').value;
  const mcid = document.getElementById('mcid').value;
  if (!mcid) return alert('プレイヤー名を入力してください');
  let textureUrl = "";
  let fileName = mcid + ".png";

  try {
    if (mode === "be") {
      const xuidRes = await fetch(`https://api.geysermc.org/v2/xbox/xuid/${mcid}`);
      const xuid = await xuidRes.text();
      const skinRes = await fetch(`https://api.geysermc.org/v2/skin/${xuid}`);
      const skinJson = await skinRes.json();
      textureUrl = `https://textures.minecraft.net/texture/${skinJson.texture_id}`;
    } else {
      textureUrl = `https://mineskin.eu/skin/${mcid}.png`;
    }

    console.log("Texture URL:", textureUrl);

    const response = await fetch(textureUrl);
    const blob = await response.blob();
    const arrayBuffer = await blob.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));

    const container = document.createElement('div');
    container.className = 'skin-entry';
    const canvas = document.createElement('canvas');
    container.appendChild(canvas);
    const viewer = new skinview3d.SkinViewer({ canvas, width: 200, height: 300 });
    viewer.loadSkin(textureUrl);

    const label = document.createElement('label');
    label.textContent = "画像ファイル名: ";
    const input = document.createElement('input');
    input.value = fileName;
    input.type = 'text';
    container.appendChild(label);
    container.appendChild(input);

    const dlBtn = document.createElement('button');
    dlBtn.textContent = "スキン単体Download";
    dlBtn.onclick = () => downloadSkin(base64, input.value);
    container.appendChild(dlBtn);

    document.getElementById('skins').appendChild(container);

    skins.push({ name: mcid, base64, fileInput: input });
  } catch (e) {
    alert("取得に失敗しました。もう一度お試しください: " + e);
  }
}

function downloadSkin(base64, filename) {
  const a = document.createElement('a');
  a.href = 'data:image/png;base64,' + base64;
  a.download = filename.endsWith('.png') ? filename : filename + '.png';
  a.click();
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html>
